name: Deploy SaleMarket to Mikr.us

on:
  push:
    branches:
      - master  # WdraÅ¼aj tylko po pushu do main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name:  Pobranie kodu
        uses: actions/checkout@v3

      - name:  Ustawienie danych uwierzytelniajÄ…cych Git
        run: |
          git config --global user.email "github-actions@github.com"
          git config --global user.name "GitHub Actions"
          git config --global credential.helper store
          echo "https://${{ secrets.GITHUB_TOKEN }}@github.com" > ~/.git-credentials

      - name: ğŸŒ PoÅ‚Ä…czenie przez SSH i wdroÅ¼enie na VPS
        run: |
          sshpass -p "${{ secrets.VPS_PASSWORD }}" ssh -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << EOF
            echo ">>> PrzechodzÄ™ do katalogu aplikacji"
            cd /var/www/git/SaleMarket

            echo ">>> Pobieram najnowsze zmiany z GitHuba"
            git pull origin main

            echo ">>> BudujÄ™ aplikacjÄ™ Blazor Server do /var/www/publish/"
            dotnet publish /var/www/git/SaleMarket/SaleMarket.csproj -c Release -o /var/www/publish

            echo ">>> RestartujÄ™ usÅ‚ugÄ™ SaleMarket"
            sudo systemctl restart salemarket

            echo ">>> Sprawdzam status usÅ‚ugi"
            sudo systemctl status salemarket --no-pager
          EOF